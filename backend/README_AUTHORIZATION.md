# 🔐 権限管理システム - チーム共有事項

## ⚠️ 緊急対応済み

### 実施した改善 ✅
1. **危険な文字列検索を修正**
   - `position.include?('manager')` → ホワイトリスト方式
   - 完全一致チェックでセキュリティ向上

2. **権限フラグの追加**
   - `department_admin` フラグ追加
   - `system_admin` フラグ追加  
   - `organization_admin` フラグ追加

## 🚨 現在のリスク認識

### 残存リスク
- レガシー実装（position基盤）がまだ動作中
- 新しい管理職追加時の手動更新が必要
- 文字列ベース判定の根本的問題は未解決

### チーム共通認識事項
1. **新規ユーザー**: 必ず権限フラグを設定
2. **役職変更**: 権限フラグの更新を忘れずに
3. **権限昇格**: システム管理者による承認必須

## 📋 使用方法

### 権限チェック
```ruby
# 推奨方法
user.department_admin?  # 新しいフラグ + フォールバック
user.system_admin?      # システム管理者
user.organization_admin? # チーム管理者

# リソース別権限チェック（新機能）
user.can_manage?('Manual', :department)  # 部門のマニュアル管理
user.can_manage?('Task', :system)        # システム全体のタスク管理
```

### 権限設定
```ruby
# データベース直接更新
user.update!(department_admin: true)

# または管理画面で設定（将来実装）
```

## 🔄 移行スケジュール

| フェーズ | 状態 | 期限 | 担当 |
|----------|------|------|------|
| 緊急修正 | ✅ 完了 | 即日 | 開発チーム |
| 権限フラグ | ✅ 完了 | 即日 | バックエンド |
| RBAC実装 | 📅 予定 | 2週間 | フルスタック |
| レガシー削除 | 📅 予定 | 1ヶ月 | バックエンド |

## 🛡️ セキュリティガイドライン

### 権限付与時の確認事項
- [ ] 業務上の必要性を確認
- [ ] 最小権限の原則を適用  
- [ ] 期限付き権限の検討
- [ ] 承認者の記録

### 定期監査（月次）
- [ ] 不要な権限の削除
- [ ] 退職者の権限剥奪確認
- [ ] 権限変更ログの確認
- [ ] セキュリティインシデントの確認

## 📞 緊急時対応

### 権限関連の問題発生時
1. **即座に該当ユーザーの権限を無効化**
   ```sql
   UPDATE users SET department_admin = false WHERE id = 'user_id';
   ```

2. **システム管理者に報告**
3. **インシデントログに記録**
4. **根本原因分析の実施**

### 連絡先
- **セキュリティ担当**: [担当者名]
- **システム管理者**: [管理者名]
- **緊急連絡先**: [連絡先]

## 📚 開発時の注意事項

### コードレビュー必須項目
- [ ] 権限チェックの実装確認
- [ ] SQLインジェクション対策確認
- [ ] ログ出力の実装確認
- [ ] テストケースの実装確認

### 禁止事項
- ❌ 文字列検索による権限判定
- ❌ ハードコーディングされた権限
- ❌ クライアントサイドのみの権限チェック
- ❌ ログ記録なしの権限変更

---

**最終更新**: 2025年1月  
**文書バージョン**: 1.0  
**承認者**: [承認者名] 
